<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>çŒ«å’ªè¿½é€æ¸¸æˆ ğŸ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            overflow: hidden;
            background: #ffffff;
            font-family: Arial, sans-serif;
        }

        /* æ¬¢è¿å±å¹• */
        #welcomeScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom:  0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        #welcomeScreen.hidden {
            display: none;
        }

        .welcome-logo {
            font-size: 100px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .welcome-title {
            font-size: 48px;
            color: white;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            text-align: center;
        }

        .welcome-subtitle {
            font-size: 24px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 50px;
            text-align:  center;
        }

        .welcome-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 400px;
        }

        .welcome-button {
            padding: 20px 40px;
            font-size: 24px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .welcome-button:active {
            transform: scale(0.95);
        }

        .btn-trial {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .btn-login {
            background: linear-gradient(135deg, #FFD93D 0%, #FF6B6B 100%);
            color: white;
        }

        .welcome-button .icon {
            font-size:  32px;
        }

        /* ç™»å½•/æ³¨å†Œå±å¹• */
        #authScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:  linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        #authScreen.show {
            display: flex;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .auth-title {
            font-size: 32px;
            color: #333;
            margin-bottom:  30px;
            text-align: center;
            font-weight: bold;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom:  30px;
        }

        .auth-tab {
            flex: 1;
            padding:  12px;
            background: #eee;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .auth-tab.active {
            background: linear-gradient(135deg, #FFD93D 0%, #FF6B6B 100%);
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            outline: none;
            transition: all 0.3s;
        }

        .form-group input:focus {
            border-color: #FF6B6B;
        }

        .form-submit {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #FFD93D 0%, #FF6B6B 100%);
            color: white;
            cursor: pointer;
            transition:  all 0.3s;
            margin-top: 10px;
        }

        .form-submit:active {
            transform: scale(0.95);
        }

        .auth-back {
            margin-top: 20px;
            text-align:  center;
            color: #666;
            cursor: pointer;
            font-size: 16px;
        }

        .auth-back:hover {
            color: #FF6B6B;
        }

        .auth-message {
            padding: 12px;
            border-radius:  8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
            display: none;
        }

        .auth-message.success {
            background: #d4edda;
            color:  #155724;
            display: block;
        }

        .auth-message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        /* æ¸¸æˆç•Œé¢ */
        #gameContainer {
            display: none;
        }

        #gameContainer.show {
            display: block;
        }

        #gameCanvas {
            display: block;
            background: #ffffff;
            cursor: none;
            touch-action: none;
        }

        /* ç”¨æˆ·ä¿¡æ¯æ  */
        #userInfo {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 15px 20px;
            color: white;
            z-index: 25;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-mode {
            padding: 6px 12px;
            background: rgba(255, 215, 61, 0.3);
            border-radius: 8px;
            font-size:  14px;
        }

        .user-mode.cloud {
            background: rgba(81, 207, 102, 0.3);
        }

        .logout-btn {
            padding: 8px 15px;
            background: rgba(255, 71, 87, 0.8);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:active {
            transform: scale(0.95);
        }

        /* çŒ«å’ªé€‰æ‹©é¢æ¿ */
        #catSelector {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-width: 600px;
            z-index: 20;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .cat-button {
            padding: 15px 20px;
            border: 3px solid #fff;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 110px;
            position: relative;
        }

        .cat-button:active {
            transform: scale(0.95);
        }

        .cat-button.active {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            border-color: #FFD93D;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
        }

        .cat-button .cat-name {
            display: block;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .cat-button .cat-score {
            display: block;
            font-size: 14px;
            opacity: 0.9;
        }

        .add-cat-button {
            padding: 15px 20px;
            border: 3px dashed #fff;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-cat-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #FFD93D;
        }

        .add-cat-button:active {
            transform: scale(0.95);
        }

        /* ç»Ÿè®¡é¢æ¿ */
        #statsPanel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            color: white;
            z-index: 20;
            min-width: 280px;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        #statsPanel h3 {
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
            color: #FFD93D;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin:  10px 0;
            font-size: 18px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-label {
            color: #aaa;
        }

        .stat-value {
            font-weight: bold;
            color:  #FFD93D;
        }

        #leaderboard {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        #leaderboard h4 {
            color: #FFD93D;
            font-size: 20px;
            margin-bottom:  15px;
            text-align: center;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            background:  rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 16px;
        }

        .leaderboard-rank {
            font-size: 24px;
            margin-right: 10px;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: bold;
        }

        .leaderboard-score {
            color: #FFD93D;
            font-weight:  bold;
        }

        /* å½“å‰åˆ†æ•° */
        #currentScore {
            position: absolute;
            top: 220px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 15px 25px;
            z-index: 20;
        }

        #currentScore .score-label {
            color: #aaa;
            font-size: 16px;
        }

        #currentScore .score-number {
            color: #FFD93D;
            font-size: 36px;
            font-weight:  bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* æ§åˆ¶æŒ‰é’® */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            z-index: 20;
            max-width: 400px;
        }

        #switchCreatureBtn {
            display: none;
        }

        .control-button {
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #fff;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .control-button:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.2);
        }

        /* UI é”å®šæŒ‰é’®ä¸éšè—æ€ */
        #uiLock {
            position: fixed;
            top: 50%;
            right: 18px;
            transform: translateY(-50%);
            width: 64px;
            height: 64px;
            border-radius: 18px;
            border: 3px solid rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.55);
            color: #fff;
            font-size: 28px;
            cursor: pointer;
            z-index: 30;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
            transition: all 0.25s ease;
        }

        #uiLock.unlocked {
            background: rgba(81, 207, 102, 0.75);
            border-color: rgba(255, 255, 255, 0.85);
            color: #0b2f16;
        }

        #uiLock:active {
            transform: translateY(-50%) scale(0.96);
        }

        #userInfo, #catSelector, #currentScore, #statsPanel, #controls, #manageCatsModal {
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .ui-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(14px);
        }

        /* ç®¡ç†çŒ«å’ªæ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom:  0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #2d3436;
            padding: 40px;
            border-radius:  20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y:  auto;
        }

        .modal-content h2 {
            color: #FFD93D;
            margin-bottom: 30px;
            text-align:  center;
            font-size: 28px;
        }

        .cat-edit-list {
            margin:  20px 0;
        }

        .cat-edit-item {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            align-items: center;
        }

        .cat-edit-item input {
            flex: 1;
            padding:  12px;
            font-size: 18px;
            border: 2px solid #fff;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            outline: none;
        }

        .cat-edit-item input:focus {
            border-color: #FFD93D;
            background: rgba(255, 255, 255, 0.2);
        }

        .cat-edit-item .remove-btn {
            padding: 12px 18px;
            background: #FF4757;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .cat-edit-item .remove-btn:active {
            transform: scale(0.95);
        }

        .add-cat-input-btn {
            width: 100%;
            padding:  15px;
            background:  rgba(255, 255, 255, 0.1);
            border: 2px dashed #fff;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .add-cat-input-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #FFD93D;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-button {
            flex: 1;
            padding:  15px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .modal-button.save {
            background: linear-gradient(135deg, #51CF66 0%, #37B24D 100%);
            color: white;
        }

        .modal-button.cancel {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .modal-button:active {
            transform: scale(0.95);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- æ¬¢è¿å±å¹• -->
    <div id="welcomeScreen">
        <div class="welcome-logo">ğŸ±</div>
        <h1 class="welcome-title">çŒ«å’ªè¿½é€æ¸¸æˆ</h1>
        <p class="welcome-subtitle">è®©ä½ çš„çŒ«å’ªäº«å—è¿½é€çš„ä¹è¶£</p>
        <div class="welcome-buttons">
            <button class="welcome-button btn-trial" id="btnTrial">
                <span class="icon">ğŸ®</span>
                <span>ä½“éªŒä¸€ä¸‹</span>
            </button>
            <button class="welcome-button btn-login" id="btnLogin">
                <span class="icon">â˜ï¸</span>
                <span>ç™»å½•/åˆ›å»ºè´¦æˆ·</span>
            </button>
        </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œå±å¹• -->
    <div id="authScreen">
        <div class="auth-container">
            <h2 class="auth-title">ğŸ± çŒ«å’ªè´¦æˆ·</h2>
            
            <div class="auth-message" id="authMessage"></div>

            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">ç™»å½•</button>
                <button class="auth-tab" data-tab="register">æ³¨å†Œ</button>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <form class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="loginEmail" placeholder="è¾“å…¥ä½ çš„é‚®ç®±" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="form-submit">ç™»å½•</button>
            </form>

            <!-- æ³¨å†Œè¡¨å• -->
            <form class="auth-form" id="registerForm">
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="registerEmail" placeholder="è¾“å…¥ä½ çš„é‚®ç®±" required>
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="registerPassword" placeholder="è‡³å°‘6ä½" required minlength="6">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤å¯†ç </label>
                    <input type="password" id="registerPasswordConfirm" placeholder="å†æ¬¡è¾“å…¥å¯†ç " required minlength="6">
                </div>
                <button type="submit" class="form-submit">åˆ›å»ºè´¦æˆ·</button>
            </form>

            <div class="auth-back" id="authBack">â† è¿”å›</div>
        </div>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div id="gameContainer">
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <div id="userInfo">
            <span class="user-mode" id="userMode">ä½“éªŒæ¨¡å¼</span>
            <span id="userEmail"></span>
            <button class="logout-btn" id="logoutBtn">é€€å‡º</button>
        </div>

        <!-- çŒ«å’ªé€‰æ‹©å™¨ -->
        <div id="catSelector"></div>

        <!-- å½“å‰åˆ†æ•° -->
        <div id="currentScore">
            <div class="score-label">æœ¬å±€å¾—åˆ†</div>
            <div class="score-number">0</div>
        </div>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div id="statsPanel">
            <h3>ğŸ“Š å½“å‰çŒ«å’ªç»Ÿè®¡</h3>
            <div class="stat-row">
                <span class="stat-label">æ€»å¾—åˆ†: </span>
                <span class="stat-value" id="totalScore">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">æ¸¸æˆæ—¶é•¿:</span>
                <span class="stat-value" id="playTime">0åˆ†0ç§’</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">å¹³å‡åˆ†/10åˆ†é’Ÿ:</span>
                <span class="stat-value" id="avgScore">0.0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">æ•è·æ¬¡æ•°:</span>
                <span class="stat-value" id="catchCount">0</span>
            </div>

            <div id="leaderboard">
                <h4>ğŸ† çŒ«å’ªæ’è¡Œæ¦œ</h4>
                <div id="leaderboardList"></div>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div id="controls">
            <button class="control-button" id="manageCatsBtn">ğŸ‘¥ ç®¡ç†çŒ«å’ª</button>
            <button class="control-button" id="resetStatsBtn">ğŸ”„ é‡ç½®ç»Ÿè®¡</button>
            <button class="control-button" id="switchCreatureBtn">ğŸ”€ åˆ‡æ¢åŠ¨ç‰©</button>
        </div>

        <!-- ç®¡ç†çŒ«å’ªæ¨¡æ€æ¡† -->
        <div id="manageCatsModal" class="modal">
            <div class="modal-content">
                <h2>ğŸ‘¥ ç®¡ç†çŒ«å’ª</h2>
                <div class="cat-edit-list" id="catEditList"></div>
                <button class="add-cat-input-btn" id="addCatInputBtn">â• æ·»åŠ æ–°çŒ«å’ª</button>
                <div class="modal-buttons">
                    <button class="modal-button cancel" id="cancelManageBtn">å–æ¶ˆ</button>
                    <button class="modal-button save" id="saveManageBtn">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <button id="uiLock" aria-label="é•¿æŒ‰è§£é”åŠŸèƒ½åŒºåŸŸ" title="é•¿æŒ‰è§£é”æ˜¾ç¤ºåŠŸèƒ½ UI">ğŸ”’</button>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase é…ç½®ï¼ˆéœ€è¦æ›¿æ¢ä¸ºä½ è‡ªå·±çš„é…ç½®ï¼‰
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket:  "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId:  "YOUR_APP_ID"
        };

        // åˆå§‹åŒ– Firebaseï¼ˆå¦‚æœé…ç½®äº†çš„è¯ï¼‰
        let firebaseInitialized = false;
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                firebaseInitialized = true;
            }
        } catch (e) {
            console.log("Firebase not configured, using local mode only");
        }

        // æ¸¸æˆçŠ¶æ€
        let storageMode = null; // 'local' æˆ– 'cloud'
        let currentUser = null;
        let cats = [];
        let currentCatId = null;
        let nextCatId = 1;
        let creatures = [];
        let particles = [];
        let creatureType = 'tadpole';
        let uiLocked = true;
        let unlockTimer = null;
        const unlockHoldMs = 700;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas. height = window.innerHeight;

        const uiElements = [
            document.getElementById('userInfo'),
            document.getElementById('catSelector'),
            document.getElementById('currentScore'),
            document.getElementById('statsPanel'),
            document.getElementById('controls'),
            document.getElementById('manageCatsModal')
        ];

        // ============ æ¬¢è¿å±å¹•é€»è¾‘ ============
        document.getElementById('btnTrial').addEventListener('click', () => {
            storageMode = 'local';
            startGame();
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            if (! firebaseInitialized) {
                showAuthMessage('è¯·å…ˆé…ç½® Firebaseï¼Œæˆ–ä½¿ç”¨ä½“éªŒæ¨¡å¼', 'error');
                return;
            }
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('authScreen').classList.add('show');
        });

        // ============ è®¤è¯å±å¹•é€»è¾‘ ============
        document. querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Form').classList.add('active');
                hideAuthMessage();
            });
        });

        document.getElementById('authBack').addEventListener('click', () => {
            document.getElementById('authScreen').classList.remove('show');
            document.getElementById('welcomeScreen').classList.remove('hidden');
            hideAuthMessage();
        });

        // ç™»å½•
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document. getElementById('loginPassword').value;

            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                storageMode = 'cloud';
                showAuthMessage('ç™»å½•æˆåŠŸï¼', 'success');
                setTimeout(() => {
                    document. getElementById('authScreen').classList.remove('show');
                    startGame();
                }, 1000);
            } catch (error) {
                showAuthMessage('ç™»å½•å¤±è´¥:  ' + error.message, 'error');
            }
        });

        // æ³¨å†Œ
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showAuthMessage('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´', 'error');
                return;
            }

            try {
                const userCredential = await firebase. auth().createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                storageMode = 'cloud';
                showAuthMessage('æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è¿›å…¥æ¸¸æˆ... ', 'success');
                setTimeout(() => {
                    document. getElementById('authScreen').classList.remove('show');
                    startGame();
                }, 1000);
            } catch (error) {
                showAuthMessage('æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
            }
        });

        function showAuthMessage(message, type) {
            const msgEl = document.getElementById('authMessage');
            msgEl.textContent = message;
            msgEl.className = 'auth-message ' + type;
        }

        function hideAuthMessage() {
            document.getElementById('authMessage').className = 'auth-message';
        }

        function applyUILockState() {
            const lockBtn = document.getElementById('uiLock');
            if (uiLocked) {
                uiElements.forEach(el => el && el.classList.add('ui-hidden'));
                lockBtn.textContent = 'ğŸ”’';
                lockBtn.classList.remove('unlocked');
                document.getElementById('manageCatsModal').classList.remove('show');
            } else {
                uiElements.forEach(el => el && el.classList.remove('ui-hidden'));
                lockBtn.textContent = 'ğŸ”“';
                lockBtn.classList.add('unlocked');
            }
        }

        function startUnlockTimer() {
            if (!uiLocked) return;
            clearTimeout(unlockTimer);
            unlockTimer = setTimeout(() => {
                uiLocked = false;
                applyUILockState();
            }, unlockHoldMs);
        }

        function cancelUnlockTimer() {
            clearTimeout(unlockTimer);
        }

        function lockUI() {
            uiLocked = true;
            applyUILockState();
        }

        function unlockUI() {
            uiLocked = false;
            applyUILockState();
        }

        // ============ æ¸¸æˆå¯åŠ¨ ============
        function startGame() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('gameContainer').classList.add('show');
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            const userModeEl = document.getElementById('userMode');
            const userEmailEl = document.getElementById('userEmail');
            
            if (storageMode === 'local') {
                userModeEl.textContent = 'ğŸ“± ä½“éªŒæ¨¡å¼';
                userModeEl.className = 'user-mode';
                userEmailEl.textContent = 'æœ¬åœ°å­˜å‚¨';
            } else {
                userModeEl.textContent = 'â˜ï¸ äº‘ç«¯åŒæ­¥';
                userModeEl.className = 'user-mode cloud';
                userEmailEl.textContent = currentUser.email;
            }

            loadData();
            updateAllUI();
            initGame();
            uiLocked = true;
            applyUILockState();
        }

        // é€€å‡ºç™»å½•
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿæœªä¿å­˜çš„æ•°æ®å°†ä¼šä¸¢å¤±ã€‚')) {
                if (storageMode === 'cloud' && firebaseInitialized) {
                    await firebase.auth().signOut();
                }
                location.reload();
            }
        });

        // ============ æ•°æ®ç®¡ç† ============
        function initDefaultCats() {
            cats = [
                {
                    id: 1,
                    name: 'çŒ«å’ª1',
                    totalScore: 0,
                    sessionScore: 0,
                    startTime: Date.now(),
                    playTimeSeconds: 0,
                    catchCount: 0
                },
                {
                    id: 2,
                    name: 'çŒ«å’ª2',
                    totalScore: 0,
                    sessionScore:  0,
                    startTime: Date.now(),
                    playTimeSeconds: 0,
                    catchCount: 0
                }
            ];
            currentCatId = 1;
            nextCatId = 3;
        }

        async function loadData() {
            if (storageMode === 'cloud' && firebaseInitialized && currentUser) {
                // ä» Firebase åŠ è½½
                try {
                    const snapshot = await firebase.database()
                        .ref('users/' + currentUser.uid + '/gameData')
                        .once('value');
                    
                    const data = snapshot.val();
                    if (data) {
                        cats = data.cats || [];
                        currentCatId = data.currentCatId || (cats.length > 0 ?  cats[0].id : null);
                        nextCatId = data.nextCatId || 1;
                    } else {
                        initDefaultCats();
                    }
                } catch (error) {
                    console.error('Load from cloud failed:', error);
                    initDefaultCats();
                }
            } else {
                // ä» localStorage åŠ è½½
                const saved = localStorage.getItem('catGameDataMulti');
                if (saved) {
                    const data = JSON.parse(saved);
                    cats = data.cats || [];
                    currentCatId = data.currentCatId || (cats.length > 0 ? cats[0].id :  null);
                    nextCatId = data.nextCatId || 1;
                } else {
                    initDefaultCats();
                }
            }

            if (cats.length === 0) {
                initDefaultCats();
            }
        }

        async function saveData() {
            const data = {
                cats,
                currentCatId,
                nextCatId,
                lastUpdate: Date.now()
            };

            if (storageMode === 'cloud' && firebaseInitialized && currentUser) {
                // ä¿å­˜åˆ° Firebase
                try {
                    await firebase.database()
                        .ref('users/' + currentUser.uid + '/gameData')
                        .set(data);
                } catch (error) {
                    console.error('Save to cloud failed:', error);
                }
            } else {
                // ä¿å­˜åˆ° localStorage
                localStorage.setItem('catGameDataMulti', JSON.stringify(data));
            }
        }

        function getCurrentCat() {
            return cats.find(cat => cat.id === currentCatId);
        }

        function addCat(name) {
            const newCat = {
                id:  nextCatId++,
                name:  name || `çŒ«å’ª${nextCatId}`,
                totalScore: 0,
                sessionScore: 0,
                startTime: Date.now(),
                playTimeSeconds: 0,
                catchCount: 0
            };
            cats.push(newCat);
            if (! currentCatId) {
                currentCatId = newCat.id;
            }
            return newCat;
        }

        function switchCat(catId) {
            currentCatId = catId;
            const cat = getCurrentCat();
            if (cat) {
                cat.startTime = Date.now();
                cat.sessionScore = 0;
            }
            renderCatSelector();
            updateAllUI();
            saveData();
        }

        // ============ UI æ¸²æŸ“ ============
        function renderCatSelector() {
            const selector = document.getElementById('catSelector');
            selector.innerHTML = '';

            cats.forEach(cat => {
                const button = document.createElement('button');
                button.className = 'cat-button';
                if (cat.id === currentCatId) {
                    button. classList.add('active');
                }
                button.innerHTML = `
                    <span class="cat-name">ğŸ± ${cat.name}</span>
                    <span class="cat-score">æ€»åˆ†:  ${cat.totalScore}</span>
                `;
                button.addEventListener('click', () => {
                    switchCat(cat.id);
                });
                selector.appendChild(button);
            });

            const addButton = document.createElement('button');
            addButton. className = 'add-cat-button';
            addButton.innerHTML = 'â•';
            addButton.addEventListener('click', () => {
                const name = prompt('è¯·è¾“å…¥æ–°çŒ«å’ªçš„åå­—: ');
                if (name && name.trim()) {
                    addCat(name.trim());
                    renderCatSelector();
                    updateAllUI();
                    saveData();
                }
            });
            selector.appendChild(addButton);
        }

        function updateStats() {
            const cat = getCurrentCat();
            if (!cat) return;

            cat.playTimeSeconds += 1;

            const minutes = Math.floor(cat.playTimeSeconds / 60);
            const seconds = cat.playTimeSeconds % 60;
            
            const avgPer10Min = cat.playTimeSeconds > 0 
                ? (cat.totalScore / cat.playTimeSeconds * 600).toFixed(1)
                : '0.0';

            document.getElementById('totalScore').textContent = cat.totalScore;
            document.getElementById('playTime').textContent = `${minutes}åˆ†${seconds}ç§’`;
            document.getElementById('avgScore').textContent = avgPer10Min;
            document.getElementById('catchCount').textContent = cat.catchCount;

            updateLeaderboard();
        }

        function updateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';

            const sortedCats = [... cats].sort((a, b) => {
                const avgA = a.playTimeSeconds > 0 ? (a.totalScore / a.playTimeSeconds * 600) : 0;
                const avgB = b.playTimeSeconds > 0 ? (b.totalScore / b.playTimeSeconds * 600) : 0;
                return avgB - avgA;
            });

            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];

            sortedCats.forEach((cat, index) => {
                const avgScore = cat.playTimeSeconds > 0 
                    ? (cat.totalScore / cat.playTimeSeconds * 600).toFixed(1)
                    : '0.0';

                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <span class="leaderboard-rank">${medals[index] || (index + 1) + '.'}</span>
                    <span class="leaderboard-name">${cat.name}</span>
                    <span class="leaderboard-score">${avgScore}/10åˆ†</span>
                `;
                leaderboardList.appendChild(item);
            });
        }

        function updateAllUI() {
            renderCatSelector();
            const cat = getCurrentCat();
            if (cat) {
                document.querySelector('#currentScore .score-number').textContent = cat.sessionScore;
            }
            updateStats();
        }

        // ============ æ¸¸æˆé€»è¾‘ ============
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(frequency, duration) {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext. currentTime + duration);
            } catch (e) {}
        }

        class Creature {
            constructor() {
                this.size = Math.random() * 25 + 70; // larger tadpole body
                this.x = Math.random() * (canvas.width - this.size);
                this.y = Math.random() * (canvas.height - this.size);
                this.speedX = (Math.random() - 0.5) * 4;
                this.speedY = (Math.random() - 0.5) * 4;
                this.color = '#000';
                this.scared = false;
                this.scaredTime = 0;
                this.wavePhase = Math.random() * Math.PI * 2;
                this.edgeBoost = 0;
            }

            update() {
                if (Math.random() < 0.02) {
                    this.speedX = (Math.random() - 0.5) * 4;
                    this.speedY = (Math.random() - 0.5) * 4;
                }

                if (this.scared) {
                    this.scaredTime--;
                    if (this.scaredTime <= 0) this.scared = false;
                }

                this.wavePhase += 0.18 + this.edgeBoost * 0.04;

                const centerX = this.x + this.size / 2;
                const centerY = this.y + this.size / 2;
                const proximity = Math.max(0, Math.min(centerX, centerY, canvas.width - centerX, canvas.height - centerY));
                const cautionFactor = proximity < 160 ? 0.35 + 0.9 * (proximity / 160) : 1.35;
                this.edgeBoost = proximity < 160 ? 0 : Math.min(0.8, this.edgeBoost + 0.08);
                const speedMultiplier = (this.scared ? 1.5 : 1) * (cautionFactor + this.edgeBoost);

                this.x += this.speedX * speedMultiplier;
                this.y += this.speedY * speedMultiplier;

                if (this.x <= 0 || this.x >= canvas.width - this.size) {
                    this.speedX *= -1;
                    this.x = Math.max(0, Math.min(this.x, canvas.width - this.size));
                }
                if (this.y <= 0 || this.y >= canvas.height - this.size) {
                    this.speedY *= -1;
                    this.y = Math.max(0, Math.min(this.y, canvas.height - this.size));
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x + this.size / 2, this.y + this.size / 2);
                this.drawTadpole();
                ctx.restore();
            }

            drawTadpole() {
                const bodyLength = this.size * 0.85;
                const bodyHeight = this.size * 0.55;
                const headRadius = this.size * 0.28;
                const tailLength = this.size * 1.35;
                const tailWave = Math.sin(this.wavePhase) * bodyHeight * 0.4;

                // Tail (long and waving)
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(bodyLength * 0.1, 0);
                ctx.quadraticCurveTo(tailLength * 0.35, bodyHeight * 0.45 + tailWave, tailLength, tailWave * 0.4);
                ctx.quadraticCurveTo(tailLength * 0.35, -bodyHeight * 0.45 + tailWave, bodyLength * 0.1, 0);
                ctx.fill();

                // Body
                ctx.beginPath();
                ctx.ellipse(0, 0, bodyLength * 0.6, bodyHeight * 0.6, 0, 0, Math.PI * 2);
                ctx.fill();

                // Head
                ctx.beginPath();
                ctx.arc(-bodyLength * 0.3, 0, headRadius, 0, Math.PI * 2);
                ctx.fill();

                // Eye
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(-bodyLength * 0.4, -headRadius * 0.35, headRadius * 0.28, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(-bodyLength * 0.42, -headRadius * 0.35, headRadius * 0.15, 0, Math.PI * 2);
                ctx.fill();
            }

            isClicked(x, y) {
                const dx = x - (this.x + this.size / 2);
                const dy = y - (this.y + this.size / 2);
                return Math.sqrt(dx * dx + dy * dy) < this.size / 2;
            }

            runAway(fromX, fromY) {
                const dx = this.x - fromX;
                const dy = this.y - fromY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < 140) {
                    this.scared = true;
                    this.scaredTime = 30;
                    this.speedX = (dx / distance) * 6;
                    this.speedY = (dy / distance) * 6;
                }
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 8 + 4;
                this.speedX = (Math.random() - 0.5) * 10;
                this.speedY = (Math.random() - 0.5) * 10;
                this.color = color;
                this.life = 30;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.speedY += 0.3;
                this.life--;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.life / 30;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math. PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        function spawnCreature() {
            if (creatures.length === 0) {
                creatures.push(new Creature());
            }
        }

        function handleTouch(x, y) {
            const cat = getCurrentCat();
            if (!cat) return;

            let caught = false;
            
            creatures.forEach((creature, index) => {
                if (creature.isClicked(x, y)) {
                    cat.sessionScore += 10;
                    cat.totalScore += 10;
                    cat.catchCount += 1;
                    
                    playSound(800, 0.1);
                    
                    for (let i = 0; i < 15; i++) {
                        particles.push(new Particle(
                            creature.x + creature.size / 2,
                            creature. y + creature.size / 2,
                            creature.color
                        ));
                    }
                    
                    creatures.splice(index, 1);
                    spawnCreature();
                    caught = true;
                    
                    updateAllUI();
                    saveData();
                } else {
                    creature.runAway(x, y);
                }
            });

            if (!caught) {
                creature.runAway(x, y);
                playSound(200, 0.05);
            }
        }

        function gameLoop() {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            creatures.forEach(creature => {
                creature.update();
                creature.draw();
            });

            particles = particles.filter(particle => {
                particle.update();
                particle.draw();
                return particle.life > 0;
            });

            requestAnimationFrame(gameLoop);
        }

        function initGame() {
            creatures = [];
            spawnCreature();

            canvas.addEventListener('click', (e) => {
                handleTouch(e.clientX, e.clientY);
            });

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                handleTouch(touch. clientX, touch.clientY);
            });

            setInterval(() => {
                if (creatures.length < 1) {
                    spawnCreature();
                }
            }, 3000);

            setInterval(() => {
                if (getCurrentCat()) {
                    updateStats();
                    saveData();
                }
            }, 1000);

            gameLoop();
        }

        // ============ UI é”å®šæŒ‰é’®é€»è¾‘ ============
        const uiLockBtn = document.getElementById('uiLock');
        uiLockBtn.addEventListener('mousedown', startUnlockTimer);
        uiLockBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startUnlockTimer();
        });
        ['mouseup', 'mouseleave'].forEach(evt => uiLockBtn.addEventListener(evt, cancelUnlockTimer));
        uiLockBtn.addEventListener('touchend', () => {
            cancelUnlockTimer();
            if (!uiLocked) lockUI();
        });
        uiLockBtn.addEventListener('click', () => {
            if (!uiLocked) {
                lockUI();
            }
        });

        // ============ æ§åˆ¶æŒ‰é’® ============
        document.getElementById('manageCatsBtn').addEventListener('click', () => {
            const modal = document.getElementById('manageCatsModal');
            const editList = document.getElementById('catEditList');
            editList.innerHTML = '';

            cats.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'cat-edit-item';
                item.innerHTML = `
                    <input type="text" value="${cat.name}" data-cat-id="${cat.id}" maxlength="15">
                    <button class="remove-btn" data-cat-id="${cat.id}">ğŸ—‘ï¸</button>
                `;
                editList.appendChild(item);
            });

            editList.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const catId = parseInt(btn.dataset.catId);
                    if (cats.length <= 1) {
                        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€åªçŒ«å’ªï¼');
                        return;
                    }
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™åªçŒ«å’ªçš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                        btn.parentElement.remove();
                    }
                });
            });

            modal.classList.add('show');
        });

        document.getElementById('addCatInputBtn').addEventListener('click', () => {
            const editList = document.getElementById('catEditList');
            const item = document.createElement('div');
            item.className = 'cat-edit-item';
            item.innerHTML = `
                <input type="text" value="æ–°çŒ«å’ª" data-cat-id="new-${Date.now()}" maxlength="15">
                <button class="remove-btn">ğŸ—‘ï¸</button>
            `;
            item.querySelector('.remove-btn').addEventListener('click', () => {
                item.remove();
            });
            editList.appendChild(item);
        });

        document.getElementById('saveManageBtn').addEventListener('click', () => {
            const editList = document.getElementById('catEditList');
            const inputs = editList.querySelectorAll('input');
            
            const oldCats = [... cats];
            cats = [];

            inputs.forEach(input => {
                const catId = input.dataset.catId;
                const name = input.value.trim() || 'æœªå‘½åçŒ«å’ª';

                if (catId. startsWith('new-')) {
                    addCat(name);
                } else {
                    const oldCat = oldCats.find(c => c.id === parseInt(catId));
                    if (oldCat) {
                        oldCat.name = name;
                        cats.push(oldCat);
                    }
                }
            });

            if (! cats.find(c => c.id === currentCatId)) {
                currentCatId = cats.length > 0 ? cats[0].id : null;
            }

            updateAllUI();
            saveData();
            document.getElementById('manageCatsModal').classList.remove('show');
        });

        document.getElementById('cancelManageBtn').addEventListener('click', () => {
            document.getElementById('manageCatsModal').classList.remove('show');
        });

        document.getElementById('resetStatsBtn').addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰çŒ«å’ªçš„ç»Ÿè®¡æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                cats. forEach(cat => {
                    cat.totalScore = 0;
                    cat.sessionScore = 0;
                    cat.playTimeSeconds = 0;
                    cat.catchCount = 0;
                    cat.startTime = Date.now();
                });
                updateAllUI();
                saveData();
            }
        });

        // å·²ç§»é™¤åˆ‡æ¢åŠ¨ç‰©æŒ‰é’®é€»è¾‘ï¼ˆä»…ä¿ç•™å•åªèŒèšªï¼‰

        window.addEventListener('resize', () => {
            canvas. width = window.innerWidth;
            canvas. height = window.innerHeight;
        });
    </script>
</body>
</html>
